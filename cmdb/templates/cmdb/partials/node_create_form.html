<h3 class="text-lg font-medium text-gray-900 dark:text-white">Create new {{ label }}</h3>

<!-- DEBUG: Show what we received -->
{% comment %}
Form fields count: {{ form_fields|length }}
{% for field in form_fields %}
  Field: {{ field.key }}, Type: {{ field.type }}, Has choices: {{ field.choices|default:"No" }}
{% endfor %}
{% endcomment %}

{% if error %}
    <div class="mt-4 p-3 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded">
        {{ error }}
    </div>
{% endif %}

<form 
    hx-post="{% url 'cmdb:node_create' label %}"
    hx-target="#create-modal-content"
    hx-swap="innerHTML"
    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
    hx-on::after-request="if(event.detail.successful) { document.getElementById('create-modal').close(); htmx.trigger('#nodes-content', 'refresh'); }">

    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

    {% if form_fields %}
        <div class="space-y-4 mb-6">
            {% for field in form_fields %}
                <div>
                    <label for="{{ field.input_name }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                        {{ field.key }}
                        {% if field.required %}
                            <span class="text-red-600">*</span>
                        {% endif %}
                    </label>
                    {% if field.type == 'select' %}
                        <select 
                            id="{{ field.input_name }}" 
                            name="{{ field.input_name }}"
                            {% if field.required %}required{% endif %}
                            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                            {% if not field.required %}
                                <option value="">-- Select {{ field.key }} --</option>
                            {% else %}
                                <option value="" disabled selected>-- Select {{ field.key }} --</option>
                            {% endif %}
                            {% for choice in field.choices %}
                                <option value="{{ choice }}" {% if field.value == choice %}selected{% endif %}>{{ choice }}</option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <input type="{{ field.type }}" 
                            id="{{ field.input_name }}" 
                            name="{{ field.input_name }}"
                            value="{{ field.value }}"
                            {% if field.required %}required{% endif %}
                            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500 dark:text-gray-400 italic">No properties defined for this type.</p>
    {% endif %}

    <!-- Raw JSON fallback/override -->
    <div class="mt-6">
        <label for="properties" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Raw JSON (merges with fields above)</label>
        <textarea 
            id="properties" 
            name="properties" 
            rows="4"
            class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm font-mono"
            placeholder='{"extra_key": "value"}'></textarea>
    </div>

    <div class="mt-6 flex justify-end gap-3">
        <button type="button" onclick="document.getElementById('create-modal').close()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
            Cancel
        </button>
        <button type="submit" class="px-4 py-2 bg-indigo-600 dark:bg-indigo-700 text-white rounded-md hover:bg-indigo-700 dark:hover:bg-indigo-800">
            Create {{ label }}
        </button>
    </div>
</form>