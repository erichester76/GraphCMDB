{% extends "base.html" %}

{% block title %}{{ label }} - Graph CMDB{% endblock %}

{% block page_title %}{{ label }} Nodes{% endblock %}

{% block header_actions %}
    <div class="flex items-center gap-4">
        <button 
            hx-get="{% url 'cmdb:node_create' label %}" 
            hx-target="#create-modal-content"
            hx-swap="innerHTML"
            hx-trigger="click"
            onclick="document.getElementById('create-modal').showModal()"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
            Create {{ label }}
        </button>

        <button 
            hx-get="{% url 'cmdb:nodes_list' label %}" 
            hx-target="#nodes-content"
            hx-swap="innerHTML"
            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Refresh
        </button>
    </div>
{% endblock %}

{% block content %}
<div id="nodes-content" class="bg-white shadow rounded-lg overflow-hidden">
    {% include "cmdb/partials/nodes_table.html" %}
</div>

<!-- Trigger modal open (hidden button for HTMX) -->
<button 
    id="open-create-modal" 
    onclick="document.getElementById('create-modal').showModal()"
    class="hidden">
</button>

<script>
document.body.addEventListener('nodeCreated', function(evt) {
    // Close modal on success
    document.getElementById('create-modal').close();
    // Refresh table
    htmx.trigger('#nodes-content', 'refresh');
});
document.body.addEventListener('nodeUpdated', function() {
    htmx.trigger('#nodes-content', 'refresh');
});
document.body.addEventListener('nodeDeleted', function() {
    htmx.trigger('#nodes-content', 'refresh');
});
</script>

<!-- Edit Modal -->
<dialog id="edit-modal" class="p-6 bg-white rounded-lg shadow-xl max-w-lg w-full">
    <div id="edit-modal-content"></div>
</dialog>

<!-- Create Modal -->
<dialog id="create-modal" class="p-6 bg-white rounded-lg shadow-xl max-w-lg w-full">
    <div id="create-modal-content" class="space-y-4">
        <h3 class="text-lg font-medium text-gray-900">Create new {{ label }}</h3>
        
        <form 
            hx-post="{% url 'cmdb:node_create' label %}"
            hx-target="#create-modal-content"
            hx-swap="innerHTML"
            hx-on::after-request="if(event.detail.successful) htmx.trigger('#nodes-content', 'nodeCreated')">
            
            <label for="properties" class="block text-sm font-medium text-gray-700">Properties (JSON)</label>
            <textarea 
                id="properties" 
                name="properties" 
                rows="6"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm font-mono"
                placeholder='{"name": "New Site", "city": "Atlanta", "country": "US"}'
            ></textarea>

            <div class="mt-4 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('create-modal').close()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    Create
                </button>
            </div>
        </form>
    </div>
</dialog>

{% endblock %}