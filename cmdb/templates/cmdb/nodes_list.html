{% extends "base.html" %}

{% block title %}{{ label }} - Graph CMDB{% endblock %}

{% block page_title %}{{ label }} Nodes{% endblock %}

{% block header_actions %}
    <div class="flex items-center gap-4">
        <button 
            hx-get="{% url 'cmdb:node_create' label %}" 
            hx-target="#create-modal-content"
            hx-swap="innerHTML"
            hx-trigger="click"
            onclick="document.getElementById('create-modal').showModal()"
            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
            Create {{ label }}
        </button>

        <button 
            hx-get="{% url 'cmdb:nodes_list' label %}" 
            hx-target="#nodes-content"
            hx-swap="innerHTML"
            class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Refresh
        </button>
    </div>
{% endblock %}

{% block extra_js %}
<script>
// Register Alpine.js component for nodes table
document.addEventListener('alpine:init', () => {
    Alpine.data('nodesTable', (config) => ({
        searchTerm: '',
        sortColumn: '',
        sortDirection: 'asc',
        visibleColumns: config.propertyKeys || [],
        allColumns: config.propertyKeys || [],
        label: config.label || '',
        csrfToken: config.csrfToken || '',
        nodesData: config.nodesData || [],
        detailUrlTemplate: config.detailUrlTemplate || '',
        deleteUrlTemplate: config.deleteUrlTemplate || '',
        ID_DISPLAY_LENGTH: 12,
        
        get nodes() {
            return this.nodesData.map(node => ({
                id: node.id,
                idShort: node.id.substring(0, this.ID_DISPLAY_LENGTH),
                idFull: node.id,
                properties: node.properties,
                label: this.label,
                csrfToken: this.csrfToken
            }));
        },
        
        toggleColumn(col) {
            const index = this.visibleColumns.indexOf(col);
            if (index > -1) {
                this.visibleColumns.splice(index, 1);
            } else {
                this.visibleColumns.push(col);
            }
        },
        
        isColumnVisible(col) {
            return this.visibleColumns.includes(col);
        },
        
        sortBy(column) {
            if (this.sortColumn === column) {
                this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortColumn = column;
                this.sortDirection = 'asc';
            }
        },
        
        getPropertyValue(node, key) {
            return node.properties[key] || '-';
        },
        
        getDetailUrl(node) {
            return this.detailUrlTemplate.replace('__LABEL__', node.label).replace('__ID__', node.id);
        },
        
        getDeleteUrl(node) {
            return this.deleteUrlTemplate.replace('__LABEL__', node.label).replace('__ID__', node.id);
        },
        
        handleDelete(node) {
            if (confirm('Delete this node? This action cannot be undone.')) {
                htmx.ajax('POST', this.getDeleteUrl(node), {
                    target: '#nodes-content',
                    swap: 'innerHTML',
                    headers: { 'X-CSRFToken': node.csrfToken }
                });
            }
        },
        
        matchesSearch(node) {
            if (!this.searchTerm) return true;
            const searchLower = this.searchTerm.toLowerCase();
            
            // Search in ID
            if (node.id.toLowerCase().includes(searchLower)) return true;
            
            // Search in all properties
            for (const [key, value] of Object.entries(node.properties)) {
                if (String(value).toLowerCase().includes(searchLower)) return true;
            }
            
            return false;
        },
        
        get filteredSortedNodes() {
            let result = this.nodes.filter(node => this.matchesSearch(node));
            
            if (this.sortColumn) {
                result = result.sort((a, b) => {
                    let aVal, bVal;
                    
                    if (this.sortColumn === 'id') {
                        aVal = a.id;
                        bVal = b.id;
                    } else {
                        aVal = a.properties[this.sortColumn] || '';
                        bVal = b.properties[this.sortColumn] || '';
                    }
                    
                    // Convert to strings for comparison
                    aVal = String(aVal).toLowerCase();
                    bVal = String(bVal).toLowerCase();
                    
                    // Try numeric comparison
                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return this.sortDirection === 'asc' ? aNum - bNum : bNum - aNum;
                    }
                    
                    // String comparison
                    if (this.sortDirection === 'asc') {
                        return aVal.localeCompare(bVal);
                    } else {
                        return bVal.localeCompare(aVal);
                    }
                });
            }
            
            return result;
        }
    }));
});
</script>
{% endblock %}

{% block content %}
<div id="nodes-content" class="bg-white shadow rounded-lg overflow-hidden">
    {% include "cmdb/partials/nodes_table.html" %}
</div>

<!-- Trigger modal open (hidden button for HTMX) -->
<button 
    id="open-create-modal" 
    onclick="document.getElementById('create-modal').showModal()"
    class="hidden">
</button>

<script>
document.body.addEventListener('nodeCreated', function(evt) {
    // Close modal on success
    document.getElementById('create-modal').close();
    // Refresh table
    htmx.trigger('#nodes-content', 'refresh');
});
document.body.addEventListener('nodeUpdated', function() {
    htmx.trigger('#nodes-content', 'refresh');
});
document.body.addEventListener('nodeDeleted', function() {
    htmx.trigger('#nodes-content', 'refresh');
});
</script>

<!-- Edit Modal -->
<dialog id="edit-modal" class="p-6 bg-white rounded-lg shadow-xl max-w-lg w-full">
    <div id="edit-modal-content"></div>
</dialog>

<!-- Create Modal -->
<dialog id="create-modal" class="p-6 bg-white rounded-lg shadow-xl max-w-lg w-full">
    <div id="create-modal-content" class="space-y-4">
        <h3 class="text-lg font-medium text-gray-900">Create new {{ label }}</h3>
        
        <form 
            hx-post="{% url 'cmdb:node_create' label %}"
            hx-target="#create-modal-content"
            hx-swap="innerHTML"
            hx-on::after-request="if(event.detail.successful) htmx.trigger('#nodes-content', 'nodeCreated')">
            
            <label for="properties" class="block text-sm font-medium text-gray-700">Properties (JSON)</label>
            <textarea 
                id="properties" 
                name="properties" 
                rows="6"
                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm font-mono"
                placeholder='{"name": "New Site", "city": "Atlanta", "country": "US"}'
            ></textarea>

            <div class="mt-4 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('create-modal').close()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                    Create
                </button>
            </div>
        </form>
    </div>
</dialog>

{% endblock %}